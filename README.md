# Домашнее задание к занятию «Основы Terraform. Yandex Cloud»  
## Студент: Вдовин Вадим

------

## Задание 1

1. Изучите проект. В файле variables.tf объявлены переменные для Yandex provider.
2. Переименуйте файл personal.auto.tfvars_example в personal.auto.tfvars. Заполните переменные: идентификаторы облака, токен доступа. 
Благодаря .gitignore этот файл не попадёт в публичный репозиторий. **Вы можете выбрать иной способ безопасно передать секретные данные в terraform.**
3. Сгенерируйте или используйте свой текущий ssh-ключ. Запишите его открытую часть в переменную **vms_ssh_root_key**.
4. Инициализируйте проект, выполните код. Исправьте намеренно допущенные синтаксические ошибки. Ищите внимательно, посимвольно. Ответьте, в чём заключается их суть.
5. Ответьте, как в процессе обучения могут пригодиться параметры ```preemptible = true``` и ```core_fraction=5``` в параметрах ВМ. Ответ в документации Yandex Cloud.

В качестве решения приложите:

- скриншот ЛК Yandex Cloud с созданной ВМ;
- скриншот успешного подключения к консоли ВМ через ssh. К OS ubuntu необходимо подключаться под пользователем ubuntu: "ssh ubuntu@vm_ip_address";
- ответы на вопросы.

> ### Ответ:
> При инициализации ошибки были в объявлении ресурса "yandex_compute_instance":   
> - `platform_id = "standart-v4"` - должно быть `standard` а также есть всего v1-v3 версии. Для запуска укажем `standard-v1`  ([по доке](https://cloud.yandex.ru/docs/compute/concepts/vm-platforms))
> - `cores         = 1` - минимальное количество ядер 2 ([по доке](https://cloud.yandex.ru/docs/compute/concepts/performance-levels)) 
> 
> Параметры `preemptible` и `core_fraction` помогут сэкономить предоставленный грант на использовании ресурсов:
> - `preemptible = true` - прерываемая ВМ, т.е. работает не более 24 часов и может быть остановлена Compute Cloud в любой момент
> - `core_fraction = 5` - уровень производительности vCPU (от 5% до 100%), т.е. доля вычислительного времени физических ядер, которую гарантирует vCPU. 
> При уровне производительности 5% ВМ будет иметь доступ к физическим ядрам как минимум 5% времени — 50 миллисекунд в течение каждой секунды.
> 
> Ресурсы успешно созданы: 
> ![1](https://github.com/V4d1M63/homework/assets/130470784/e6850505-b2ea-40df-b99e-76be0582eb49)
> !![02](https://github.com/V4d1M63/homework/assets/130470784/64594e5f-f5c8-457f-b929-68e67546dfd1)
> Добавил также в outputs.tf вывод external ip, чтобы не искать его:
> ![03](https://github.com/V4d1M63/homework/assets/130470784/acd5ecfe-fd36-458f-aae2-aca92a5500f9)
> Подключаемся по ssh:
> ![04](https://github.com/V4d1M63/homework/assets/130470784/ba2cfec3-634a-472c-8214-1a56796934f3)

------

## Задание 2

1. Изучите файлы проекта.
2. Замените все хардкод-**значения** для ресурсов **yandex_compute_image** и **yandex_compute_instance** на **отдельные** переменные. К названиям переменных ВМ добавьте в начало префикс **vm_web_** .  Пример: **vm_web_name**.
3. Объявите нужные переменные в файле variables.tf, обязательно указывайте тип переменной. Заполните их **default** прежними значениями из main.tf. 
4. Проверьте terraform plan. Изменений быть не должно. 

> #### Ответ:
> Добавил необходимые переменные в variables.tf.  
> В main.tf заменил хардкод-значения, получилось:  
> ![05](https://github.com/V4d1M63/homework/assets/130470784/e2b2de38-6584-462a-835e-bb9e8eb5db7c)
> `terraform plan` подтвердил, что изменений не обнаружено:  
> ![06](https://github.com/V4d1M63/homework/assets/130470784/13942806-8e66-4a47-8126-5c0f8993761b)
> 

------

## Задание 3
 
1. Создайте в корне проекта файл 'vms_platform.tf'. Перенесите в него все переменные первой ВМ.
2. Скопируйте блок ресурса и создайте с его помощью вторую ВМ в файле main.tf: **"netology-develop-platform-db"** ,  cores  = 2, memory = 2, core_fraction = 20. Объявите её переменные с префиксом **vm_db_** в том же файле ('vms_platform.tf').
3. Примените изменения.

> #### Ответ:
> Создал vms_platform.tf, перенес в него созданные переменные, а также продублировал с vm_db_ префиксом.  
> В main.tf создал новый ресурс `yandex_compute_instance` "platform-db":
> ![07](https://github.com/V4d1M63/homework/assets/130470784/d670a43c-298b-4bdf-a23f-d4630e785df2)
> Результат `terraform apply`:
> ![08](https://github.com/V4d1M63/homework/assets/130470784/fa5f475e-4d52-43a5-8591-b6f350e6d6bf)
> ![09](https://github.com/V4d1M63/homework/assets/130470784/e523f7f2-da74-4b73-936f-8cf5d3f8422c)

------

## Задание 4

1. Объявите в файле outputs.tf output типа map, содержащий { instance_name = external_ip } для каждой из ВМ.
2. Примените изменения.

В качестве решения приложите вывод значений ip-адресов команды ```terraform output```.

> #### Ответ:
> Частично уже было выполнено, просто дополнил вызовом "name": 
> ![10](https://github.com/V4d1M63/homework/assets/130470784/d5ac1bc2-2c3c-4031-83a5-454d19479b96)
> ![11](https://github.com/V4d1M63/homework/assets/130470784/b4092a06-7cf5-4b9b-a1c6-4315c24554c1)

------

## Задание 5
 
1. В файле locals.tf опишите в **одном** local-блоке имя каждой ВМ, используйте интерполяцию ${..} с несколькими переменными по примеру из лекции.
2. Замените переменные с именами ВМ из файла variables.tf на созданные вами local-переменные.
3. Примените изменения.

> #### Ответ:
> Описание в файле locals.tf:  
>![12](https://github.com/V4d1M63/homework/assets/130470784/f8b8bfb1-391b-457e-a450-99afb7d877b8)
> 
> В main.tf теперь используем `local.web_name` и `local.db_name` в имени ВМ.  Terraform `apply` изменений не обнаружил:
> ![13](https://github.com/V4d1M63/homework/assets/130470784/3a1232ef-7f46-42a3-97b7-43c338673d8d)

------

## Задание 6

1. Вместо использования трёх переменных  ".._cores",".._memory",".._core_fraction" в блоке  resources {...}, объедините их в переменные типа **map** с именами "vm_web_resources" и "vm_db_resources". В качестве продвинутой практики попробуйте создать одну map-переменную **vms_resources** и уже внутри неё конфиги обеих ВМ — вложенный map.
2. Также поступите с блоком **metadata {serial-port-enable, ssh-keys}**, эта переменная должна быть общая для всех ваших ВМ.
3. Найдите и удалите все более не используемые переменные проекта.
4. Проверьте terraform plan. Изменений быть не должно.

> #### Ответ:
> В vms_platform.tf добавил переменные для ресурсов и метаданных:
> ![14](https://github.com/V4d1M63/homework/assets/130470784/9474f64d-bb8f-4a8f-a6de-890f8d114cc5)
> Как выглядит использование переменных:  
> ![15](https://github.com/V4d1M63/homework/assets/130470784/b73cc594-cc9b-4f6d-bfb9-eb7063fbc416)
> В файлах vms_platform.tf и variables.tf закомментировал ненужные переменные.
> `terraform plan` показал, что изменений нет:
> ![16](https://github.com/V4d1M63/homework/assets/130470784/f871ac49-9671-4cca-93ec-f74aab02d9a9)
